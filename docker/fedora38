FROM fedora:38

# note: at variance with centos7, here we have to explicitly install gcc
# mdtraj 1.9.7 does not compile with python 3.11 unless installed from source
# see https://github.com/mdtraj/mdtraj/issues/1761
RUN yum -y update 
RUN yum -y group install "Development Tools" 
RUN yum -y install gcc-c++ 
RUN yum -y install environment-modules gawk vim wget lapack-devel blas-devel \
                   zlib-devel gsl-devel fftw-devel openmpi-devel boost-devel \
                   python3 python3-devel python3-pip
RUN pip3 install numpy 
RUN pip3 install cython
RUN pip3 install pandas 
RUN pip3 install MDAnalysis 
RUN pip3 install mdtraj

RUN useradd -ms /bin/bash plumed
USER plumed
WORKDIR /home/plumed

# import plumed code.
# assumes a file plumed2.tgz is present in the Dockerfile directory
COPY plumed2.tgz /home/plumed

# build and test plumed (no install)
# FC is needed on gfortran 10 to pass regression tests
RUN . /etc/bashrc \
 && module load mpi \
 && export OMPI_MCA_btl_base_warn_component_unused=0 \
 && export OMPI_MCA_btl_base_verbose=0 \
 && export OMPI_MCA_plm=isolated \
 && export OMPI_MCA_btl_vader_single_copy_mechanism=none \
 && export OMPI_MCA_rmaps_base_oversubscribe=yes \
 && export PATH=$HOME/opt/bin:$PATH \
 && export CPATH=$HOME/opt/include:$CPATH \
 && export INCLUDE=$HOME/opt/include:$INCLUDE \
 && export LIBRARY_PATH=$HOME/opt/lib:$LIBRARY_PATH \
 && export LD_LIBRARY_PATH=$HOME/opt/lib:$LD_LIBRARY_PATH \
 && export FC="gfortran -fallow-argument-mismatch" \
 && tar xzf plumed2.tgz \
 && cd plumed2 \
 && export PYTHONPATH=$PWD/python:$PYTHONPATH \
 && export PYTHON_BIN=python3 \
 && ./configure --enable-modules=all --enable-boost_serialization \
 && make -j 4 \
 && make check

